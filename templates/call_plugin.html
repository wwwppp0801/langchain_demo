<!--doctype html-->
<html>
    <head>
        <title>langchain webui</title>
        <meta name="referrer" content="never">
        <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
    </head>
    <body>
        <div class="container">
            <header class="d-flex py-3">
                <ul class="nav nav-pills">
                    {% for nav in nav_tabs %}
                        <li class="nav-item"><a href="{{ nav.path }}" class="nav-link {% if nav.active %}active{% endif %}">{{ nav.name }}</a></li>
                    {% endfor %}
                </ul>
            </header>
            <div class="row mt-1">
                <form id="form" action="#">
                    <div class="form-group col-md-10 d-flex align-items-center">
                        <input type="text" class="form-control" id="input" placeholder="Enter a command">
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </div>
                    <div class="input-group" id="checkbox_group">

                        {% for plugin_name in plugin_names %}
                        <div class="input-group-text">
                            <input {% if loop.index==1%}checked{% endif %} class="form-check-input" name="plugin_name" type="radio" value="{{plugin_name}}" id="tool{{loop.index}}">
                            <label class="form-check-label" for="tool{{loop.index}}">{{plugin_name}}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="form-group col-md-10 d-flex align-items-center">
                        <input type="text" class="form-control" id="session_id" placeholder="session id">
                        <button type="button" id="refresh_session_id" class="btn btn-primary">session name</button>
                    </div>
                    <div class="form-group col-md-10 d-flex align-items-center">
                        <a href="/sample_data" target="_blank">测试iot设备列表</a>
                    </div>
                </form>
            </div>

            <h3>程序输出</h1>
            <div id="output" class="well"></div>
            <h3>openai请求日志</h1>
            <div id="errorlog" class="well"></div>
        </div>

        <!-- Load socket.io -->
        <!--
            <script src="{{ url_for('static', filename='socket.io.js') }}"></script>
        -->
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script src="{{ url_for('static', filename='ansi_up.js') }}"></script>
        <script src="{{ url_for('static', filename='jquery-1.7.2.min.js') }}"></script>

        <!-- Custom script -->
        <script>
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}`;
            }
            $("#session_id").val(formatDate(new Date()));
            $("#refresh_session_id").click(function(){
                $("#session_id").val(formatDate(new Date()));
            });
            let page_id=new Date().getTime()+Math.random();
            
            function getToolValues(){
                var tools = $("#checkbox_group input:checked");

                // Create an array to store the values of the checked checkboxes
                var toolValues = [];

                // Loop through each checked checkbox and push its value to the array
                tools.each(function() {
                    toolValues.push($(this).val());
                });

                // Join the array elements with a comma separator
                //var toolString = toolValues.join(",");
                //return toolString
                return toolValues[0];
            }
            // Get the socket object
            var socket = io.connect();

            // Get the DOM elements
            var form = document.getElementById('form');
            var input = document.getElementById('input');
            var output = document.getElementById('output');
            var errorlog = document.getElementById('errorlog');

            // Listen for form submit event
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                $("#output").html("")
                $("#errorlog").html("")
                var command = input.value;
                if (command) {
                    // Send the command to the server
                    socket.emit('call_plugin', {command: command,plugin_name:getToolValues(),"session_id":$("#session_id").val(),page_id});
                    // Clear the input field
                    input.value = '';
                }
            });


            function times(s,times){
                let i=0;
                let res="";
                for(i=0;i<times;i++){
                    res+=s
                }
                return res;
            }
            function replaceHeadSpace(s){
                let match=s.match(/^ +/);
                if(match){
                    s=s.replace(/^ +/,times("&nbsp;",match[0].length))
                }
                return s;
            }

            // Listen for result event from the server
            socket.on('result', function(data) {
                var line = data['line'];
                if (line) {
                    // Convert ANSI escape codes to HTML tags using ansi_up library (https://github.com/drudru/ansi_up)
                    var ansi_up = new AnsiUp;
                    var html_line = ansi_up.ansi_to_html(line);
                    // Append the result line to the output element
                    $(output).append(replaceHeadSpace(html_line) + "<br>");
                    



                    let match=null;
                    if(match=line.match(/{.*}/)){
                        try{
                            let json=JSON.parse(match[0]);
                            if(json.images){
                                let html=json.images.map(function(url){
                                    return "<div style='max-width:400px' class=\"row\"><img src=\""+url+"\"/></div>"
                                }).join("\n")
                                $(output).append(html);
                            }
                        }catch(e){}
                    }
                }
            });
            socket.on('errorlog', function(data) {
                var line = data['line'];
                if (line) {
                    // Convert ANSI escape codes to HTML tags using ansi_up library (https://github.com/drudru/ansi_up)
                    var ansi_up = new AnsiUp;
                    var html_line = ansi_up.ansi_to_html(line);
                    // Append the result line to the output element
                    errorlog.innerHTML += html_line + '<br>';
                }
            });
        </script>

    </body>
</html>

